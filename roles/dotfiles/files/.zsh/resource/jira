# 
# Jira
#

jnew() {
  jira-cli new --type=$1 --priority=Medium --project LE $2 | grep issue | pbcopy;
}

jlist() {
  jira-cli view --search-jql="$1" --oneline
}

jmine() {
  # while true
  # do
      # load before clear
      output=$(jira mine)
      clear
      echo "$output"
      sleep 2000000
  # done
}

jrun () {
  PROJECT='divi'
  PROJECT_FILE_NAME='lsc_odrs_app'
  JIRA_ID=$1
  BRANCH_CHECKOUT=$2
  NOTES_PROJECTPATH="$HOME/Documents/Notes/$PROJECT"
  CURRENT_BRANCH=$( git branch | grep '*' | cut -d ' ' -f2)
  BASE_FILE_NAME=$(basename `git rev-parse --show-toplevel`)

  if [ $BASE_FILE_NAME != $PROJECT_FILE_NAME ]; then
    echo "must be in projcet $PROJECT_FILE_NAME for jrun to work";
    return
  fi

  if [ -z $JIRA_ID ]; then
    echo "need to have the JIRA_ID in your first parameter";
    return
  fi

  if [ -z $BRANCH_CHECKOUT ] && [ $CURRENT_BRANCH != 'develop' ]; then
    echo "switching to develop branch";
    git checkout develop;
    git pull;
  fi

  if [ $BRANCH_CHECKOUT ]; then 
    echo "switching to $BRANCH_CHECKOUT";
    git checkout $BRANCH_CHECKOUT;
    git pull;
  fi

  BRANCHNAME=$(jira project $JIRA_ID)

  # Currently, you need to have a JIRA_ID so you cannot run on develop or
  # master. But here for safety measures
  if [ $BRANCHNAME = 'develop' ] || [ $BRANCHNAME = 'master' ]; then
    echo 'cannot run on $BRANCHNAME';
    exit 0;
  fi

  # limitation to having the second pane to always have vim running with notes
  # note this is a hack atm. would like to make this more specific
  tmux select-window -t :-
  tmux send-keys -t 2 ":w"
  tmux send-keys -t 2 Enter
  tmux send-keys -t 2 ":q"
  tmux send-keys -t 2 Enter

  # If branch does exists then open the notes
  if git show-ref --quiet $BRANCHNAME; then
    echo "$BRANCHNAME already exists";
    git checkout $BRANCHNAME;

    # If you have already deleted the fil then write again
    if [[ ! -f "$NOTES_PROJECTPATH/$BRANCHNAME.md" ]]; then
      jira view $JIRA_ID >> "$NOTES_PROJECTPATH/$BRANCHNAME.md";
    fi

    # open noets
    tmux send-keys -t 2 "vim $NOTES_PROJECTPATH/$BRANCHNAME.md"
    tmux send-keys -t 2 Enter;
    return;
  fi

  # create branch and notes
  echo "checking out and creating $BRANCHNAME";
  git checkout -b $BRANCHNAME
  jira view $JIRA_ID >> "$NOTES_PROJECTPATH/$BRANCHNAME.md";

  # transition to In Progress
  jtrans "In Progress" $JIRA_ID

  # open notes
  tmux send-keys -t 2 "vim $NOTES_PROJECTPATH/$BRANCHNAME.md"
  tmux send-keys -t 2 Enter;
}

jqa() {
  JIRA_ID=$1
  QA_PERSON=$2
  DEFAULT_QA_PERSON='Wesley Fermin'
  QA_WORKFLOW='QA ready'
  if [[ $JIRA_ID ]]; then
    if [[ $QA_PERSON ]]; then
      jira transition --noedit "$QA_WORKFLOW" $JIRA_ID && jira assign $JIRA_ID "$QA_PERSON"
    else
      jira transition --noedit "$QA_WORKFLOW" $JIRA_ID && jira assign $JIRA_ID $DEFAULT_QA_PERSON
    fi
  else
    echo "need to have ISSUE_ID"
  fi
}

jnotes() {
	PROJECT='divi'
	PROJECTPATH="$HOME/Documents/Notes/$PROJECT"
  if [[ -z "$1" ]]; then
    SEARCH='\- \[ \]'
  else
    SEARCH="$( echo $1 | sed 's/\([^[:alnum:]]\)/\\\1/g' | tr '[:upper:]' '[:lower:]')"
  fi

  TODOSELECT=$(awk 'function branchname(file) {
    sub(".*/", "", file)
    sub("\.md", "", file)
    return file
  }
  tolower($0) ~ /'$SEARCH'/{print branchname(FILENAME), "---", $0}' $PROJECTPATH/* | fzf)

  if [ $TODOSELECT ]; then
    BRANCHNAME=${TODOSELECT%% ---*} # Delete after
    # BRANCHNAME=${TODOSELECT##*------- } # Delete before
    tvim "$BRANCHNAME"
  fi
}

jtrans() {
  moveTo=$1
  JIRA_ID=$2

  if [ -z $JIRA_ID ]; then
    echo 'Need arg with jira ticket id'
    return
  fi
  if [ -z $moveTo ]; then
    echo 'Need a move to location'
    return
  fi
  ticketStatus="$(jira status $JIRA_ID)"
  if [ ! "$ticketStatus" ]; then
    echo "ticket $JIRA_ID does not exist"
    return
  fi

  # status
  TODO_STATUS='To Do'
  INPROGRESS_STATUS='In Progress'
  REVIEW_STATUS='Code review'
  QA_STATUS='QA Ready'

  # QA
  if [ "$moveTo" = "$QA_STATUS" ]; then
    if [ "$moveTo" = "$REVIEW_STATUS" ]; then
      jqa $JIRA_ID
      return;
    else
      echo 'ticket must be in Code review to move to QA Ready'
      return
    fi
  fi

  # Code Review
  if [ $moveTo = "$REVIEW_STATUS" ] && [ $ticketStatus = "$TODO_STATUS" ]; then 
      jira transition "$INPROGRESS_STATUS" $JIRA_ID --noedit
  fi

  # Default
  jira transition "$moveTo" $JIRA_ID --noedit
}

jtransition() {
  JIRA_ID=$1
  if [ -z $JIRA_ID ]; then
    echo 'Need arg with jira ticket id'
    return
  fi
  moveTo="$(echo 'QA Ready\nCode review\nIn Progress\nTo Do' | fzf)"
  jtrans $moveTo $JIRA_ID
}
